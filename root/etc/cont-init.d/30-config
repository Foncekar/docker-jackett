#!/usr/bin/with-contenv bash

if [ $JACKETT_PRE_BUILD -eq 1 ]; then
  url="https://api.github.com/repos/Jackett/Jackett/releases"
  vers="PRE-RELEASE"
else
  url="https://api.github.com/repos/Jackett/Jackett/releases/latest"
  vers="RELEASE"
fi

echo "**** install jackett $vers ****"
mkdir -p /app/Jackett
jack_tag=$(curl -sX GET "$url" | awk '/tag_name/{print $4;exit}' FS='[""]')
curl -o /tmp/jacket.tar.gz -L https://github.com/Jackett/Jackett/releases/download/$jack_tag/Jackett.Binaries.Mono.tar.gz
tar xf /tmp/jacket.tar.gz -C /app/Jackett --strip-components=1

echo "***** TEMP FIX FOR TRACKERS *****"

curl -o yggtorrent.yml -L https://raw.githubusercontent.com/Jackett/Jackett/4d32627382db6b03d5602adb6191e307395f3be1/src/Jackett.Common/Definitions/yggtorrent.yml
mv yggtorrent.yml /app/Jackett/Definitions/yggtorrent.yml

echo "**** fix for host id mapping error ****"
chown -R root:root /app/Jackett

chown -R abc:abc \
	/app \
	/config \
	/downloads
